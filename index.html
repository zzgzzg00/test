<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>Title</title>
    <style>
        *{
            padding: 0;
            margin: 0;
            box-sizing: border-box;
            line-height: 1.1;
        }
        .container{
            display: flex;
            justify-content:center;
            align-items:center;
        }
        .container>div{
            margin: 0 10px;
        }
        .container>div>p:nth-of-type(1){
            margin-bottom: 10px;
        }
        .container>div>p{
            border:1px solid grey;
            padding: 5px 10px;
            -webkit-appearance: button;
        }
        summary:focus{
            outline: none;
        }
        input[type=checkbox]{
            margin-right: 5px;
        }
        #container,#show{
            padding: 20px;
        }
        .write{
            display: block;
            border:1px solid grey;
            height: 50vh;
            flex: 1;
        }
        #mask{
            position: fixed;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,.3);
            display: flex;
            justify-content:center;
            align-items: center;
            color: #ffffff;
        }
        #mask.hide{
            display: none;
        }
        .type_select,.type_select2{
            margin: 10px;
            text-align: center;
        }
        .type_select>label:nth-of-type(2){
            margin-left: 20px;
        }
        ::-webkit-input-placeholder{
            color:lightslategray;
        }
        [type=url]{
            display: block;
            width: 90%;
            height: 30px;
            margin: 10px auto;
            font-size: 16px;
            line-height: 30px;
            padding: 10px;
            color: #000000;
        }
        :invalid{
            border:1px solid red;
            outline: none;
        }
        #diffresult .added,.tip_add{
            background-color: #d9edf7;
        }
        #diffresult .removed,.tip_del{
            background-color: #FDD;
        }
        #diffresult .changed,.tip_change{
            background-color: lightyellow;
        }
        #diffresult div.ignored,.tip_ignore{
            background-color: rgba(0,0,255,.2);
        }
        #diffresult div.structure{
            color: grey;
        }
        .tip_same,.tip_del,.tip_add,.tip_change,.tip_ignore{
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 1px solid #000000;
            vertical-align: middle;
            margin-left: 5px;
        }
        #diffresult div{
            position: relative;
            padding-left: 65px;
            counter-increment: add;
            height: 20px;
            line-height: 20px;
        }
        #diffresult div:after{
            display: inline-block;
            position: absolute;
            left: 0;
            top:0;
            content:counter(add);
            font-size: 12px;
            width: 60px;
            text-align: right;
        }
        #diffresult div.added:after{
            content:counter(add)' +';
        }
        #diffresult div.removed:after{
            content: counter(add)' -';
        }
        #diffresult div.changed:after{
            content: counter(add)'⇋';
        }
        #diffresult div.ignored:after{
            content: counter(add)' x';
        }
        #diffresult div.same:after{
            content: counter(add)' o';
        }
        #diffresult div>pre{
            line-height: 20px;
            vertical-align: middle;
        }
        #diffresult .changedtext{
            background-color: rgba(255,0,0,.1);
            vertical-align: middle;
        }
        h2{
            border: 1px solid grey;
            border-color: grey transparent grey transparent;
            margin: 10px auto;
        }
        [data-hide=hidden]{
            display: none !important;
        }
        [data-role=addfilter]{
            padding: 10px 5px;
        }
        [data-role=filteritem]{
            height: 20px;
            line-height: 20px;
            padding-left: 10px;
            margin-right: 5px;
            margin-left: 10px;
        }
        .headers{
            display: block;
            height: 40px;
            width: 100%;
            margin: 10px;
        }
    </style>
</head>
<body>
<script src="https://q.qunarzz.com/open_m_train/prd/scripts/zepto@5f84d4ac791c84f64346aec65b2a0083.js"></script>
<p class="type_select">
    <label for="json"><input checked="true" name="type" id="json" type="radio">json比较</label>
    <label for="url"><input name="type" id="url" type="radio">url比较</label>
</p>
<p class="type_select2 js_show">
    显示比对类型:
    <label for="same"><input value="same" data-role='ignore' name="type" id="same" type="checkbox">相同项</label>
    <label for="ignore"><input value="ignored" data-role='ignore' name="type" id="ignore" type="checkbox">忽略项</label>
    <label for="del"><input value="removed" checked="true" data-role='ignore' name="type" id="del" type="checkbox">删除项</label>
    <label for="change"><input value="changed" checked="true" data-role='ignore' name="type" id="change" type="checkbox">变更项</label>
    <label for="add"><input value="added" checked="true" data-role='ignore' name="type" id="add" type="checkbox">新增项</label>
</p>
<input type="url" placeholder="left url" disabled/>
<input type="url" required placeholder="right url" disabled/>
<div class="container">
    <textarea id="left" class="write"></textarea>
    <div>
        <p hidden id="merge">合并</p>
        <p id="diff">比较</p>
    </div>
    <textarea id="right" class="write" required></textarea>
</div>
<textarea id="header" class="headers" placeholder="setheader"></textarea>
<hr/>
<div id='container'>
    <!--
    <div data-id="id0" data-space="0" data-item="root">
        <pre><span>▼</span><input data-isleaf="false" type="checkbox" />root</pre>
    </div>-->
</div>
<h2>忽略项</h2>
<div id='result'></div>
<div id="filtercontainer">
    <input type="button" value="添加过滤条件" data-role="addfilter"/>
    &nbsp;&nbsp;若要忽略某节点，依次输入从根至该节点的Key；对于数组或Key不固定的Map，请勾选输入框右侧的复选框。
</div>
<h2>比较结果 o:<span class="tip_same"></span>same -:<span class="tip_del"></span>removed +:<span class="tip_add"></span>added ⇋:<span class="tip_change"></span>changed x:<span class="tip_ignore"></span>ignored</h2>
<div id="diffresult"></div>
<div id="mask" class="hide">生成树型结构...</div>
<script>
    try {
        var __supportes6=new Function('','const a={"a":1};const {a:_a}=a;return `${_a}`');
    }catch(e){
        location.href='./js_stringdiff_es5.html';
    }
</script>
<script>
    const [jsonDOM,urlDOM]=document.querySelectorAll('input[type="radio"]');
    const [leftUrlDOM,rightUrlDOM]=document.querySelectorAll('input[type="url"]');
    const containerDOM=document.querySelector('#container');
    const resultDOM=document.querySelector('#result');
    const resultTextarea=document.querySelector('#resulttext');
    const [leftarea,rightarea]=document.querySelectorAll('textarea');
    const maskDOM=document.querySelector('#mask');
    const diffresultDOM=document.getElementById('diffresult');
    const filtercontainer=document.getElementById('filtercontainer');
    const fold='▶',expand='▼',defaultSperator='.';
    const header=document.getElementById('header');
    let relationCaches={};
    let ignoreArr=[];
    let doubleckicksign=0;
    let difftype=0;
    const spaceReg=/^(\s+)(.*$)/g;
    const emptyReg=/^(?:(\s*\{)|(\s*\[,?))$/;
    const ignoreReg=/^\s*[\}\]],?$/;
    const keyReg=/"(.*)":(.*)$/;
    const startReg=/^\s*(\{|\[)\s*$/;
    const showItem=[...document.querySelectorAll('.js_show input')];
    const filterItem=`<input type="text" data-role="filteritem"><input data-role="filterall" type="checkbox" />`;
    function deal(data){
        maskDOM.classList.remove('hide');
        setTimeout(()=>{
            const arr=data.split(/\n/);
            const html=arr.map((item,index,arr)=>{
                let _v='';
                item=item.replace(spaceReg,'$2');
                let space=RegExp.$1;
                item=item.replace(keyReg,'$1');
                if(startReg.test(RegExp.$2)){
                    let end=RegExp.$1;
                    if(!checkIsEmpty(item)){
                        _v=end;
                    }
                }
                space=checkIsSpace(space)?space:''
                const isLeaf=arr[index+1]?arr[index+1].indexOf(space+' ')!=0:true;
                const button=isLeaf?'':`<span class="js_span">${expand}</span>`;
                const ill=`${item}${_v}`=="\"\"" || `${item}${_v}`=="\"\",";
                item=item.replace(/\\/g,'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                if(ignoreReg.test(item)){
                    return `<div data-hide="${ill?'hidden':''}" data-id="id${index+1}" data-space="${space.length/4}" data-item="${encodeURIComponent(item)}">
                            <pre>${space}<input hidden data-isleaf="false" type="checkbox" />${item.replace(/,/,'')}</pre>
                        </div>`
                }
                return `<div data-hide="${ill?'hidden':''}" ${ill?'hidden':''} data-id="id${index+1}" data-space="${space.length/4}" data-item="${encodeURIComponent(item)}" data-type="${_v}">
                        <pre>${space}${button}<input ${emptyReg.test(item)?'hidden':''} data-isleaf="${isLeaf}" type="checkbox" />${item}${_v}</pre>
                    </div>`
            });
            containerDOM.innerHTML=html.join('');
            resultDOM.innerHTML='';
            maskDOM.classList.add('hide');
            relationCaches={};
        },0);
    }
    document.body.onclick=function(e){
        const target=e.target;
        if(target.tagName.toLowerCase()=='input' && target.type == 'checkbox' && target.dataset.role != 'ignore' && target.dataset.role != 'filterall' && target.dataset.role != 'ignoreson'){
            const div=getParentDiv(target);
            if(target.checked){
                target.dataset.customer=true;
//                checkedAllChildren(div);
//                checkedAllParents(div);
            }else{
                target.dataset.customer=false;
//                canceldAllChildren(div);
//                if(!getBrothersStatus(div)){
//                    canceldAllParents(div);
//                }
            }
            const result=getSelectedLeaf();
            resultDOM.innerHTML=`<pre>${JSON.stringify(result,(key,value)=>key=='type'?undefined:value,4)}</pre>`;
            ignoreArr=result;
        }else if(target.tagName.toLowerCase()=='span' && target.classList.contains('js_span')){
            const div=getParentDiv(target);
            if(target.innerHTML==expand){
                hideChildren(div);
                target.innerHTML=fold;
            }else{
                hideChildren(div,false);
                target.innerHTML=expand;
            }

        }else if(target.tagName.toLowerCase()=='input' && target.type == 'radio'){
            if(jsonDOM.checked){
                setReadOnly([rightarea],[leftUrlDOM,rightUrlDOM]);
                difftype=0;
            }else{
                setReadOnly([leftUrlDOM,rightUrlDOM],[rightarea]);
                difftype=1;
            }
        }else if(target.dataset.role == 'addfilter'){
            const div=`
                <div data-role="filters">${filterItem}<input type="button" value="添加过滤项" data-role="addfilteritem"><input type="button" value="删除" data-role="delfilter"><input type="checkbox" data-role="ignoreson"/></div>
            `
            filtercontainer.insertAdjacentHTML('beforeend',div);
        }else if(target.dataset.role == 'addfilteritem'){
            target.insertAdjacentHTML('beforebegin',`${filterItem}`);
        }else if(target.dataset.role == "delfilter"){
            target.closest('div').outerHTML='';
        }else if(target.dataset.role == 'filterall'){
            const pre=target.previousElementSibling;
            pre.dataset.all=`${target.checked}`;
            pre.value='';
            pre.disabled=target.checked;
        }
    }
    function setReadOnly(canreadarr,cannotreadarr){
        for(let read of canreadarr){
            read.disabled=false;
        }
        for(let notread of cannotreadarr){
            notread.disabled=true;
        }
    }
    function checkIsSpace(str){
        return /^\s*$/.test(str);
    }
    function checkIsEmpty(str){
        return !/[a-z\d]/i.test(str);
    }

    function getDivData(parentDiv){
        let {id,space,item,type}=parentDiv.dataset;
        return{
            id,
            item,
            space:space<<0,
            type
        }
    }
    function getCacheData(id,type){
        if(!relationCaches[id]){
            return false;
        }
        if(!relationCaches[id][type]){
            return false;
        }
        return relationCaches[id][type];
    }
    function setCacheData(id,type,data){
        if(!relationCaches[id]){
            relationCaches[id]={};
        }
        relationCaches[id][type]=data;
    }

    function getParentDiv(input){
        return input.closest('div');
    }
    function getChildInput(parentDiv){
        return parentDiv.querySelector('input');
    }
    function getBrothersStatus(parentDiv){
        const brothers=findBrothers(parentDiv);
        for(let brother of brothers){
            if(getChildInput(brother).checked){
                return true;
            }
        }
        return false;
    }

    function findParents(parentDiv){
        const parents=[];
        let {space,id}=getDivData(parentDiv);
        const $parents=getCacheData(id,'parents');
        if($parents){
            return $parents;
        }
        --space;
        while(true){
            if(space==-1){
                break;
            }
            parentDiv=parentDiv.previousElementSibling;
            if(!parentDiv){
                break;
            }
            const {space:_space}=getDivData(parentDiv);
            if(space==_space){
                parents.push(parentDiv);
                --space;
            }
        }
        setCacheData(id,'parents',parents);
        return parents;
    }
    function findChidren(parentDiv){
        const children=[];
        const {space,id}=getDivData(parentDiv);
        const $children=getCacheData(id,'children');
        if($children){
            return $children;
        }
        while(true){
            parentDiv=parentDiv.nextElementSibling;
            if(!parentDiv){
                break;
            }
            const {space:_space}=getDivData(parentDiv);
            if(_space>space){
                children.push(parentDiv);
            }else{
                break;
            }
        }
        setCacheData(id,'children',children);
        return children;
    }
    function findBrothers(parentDiv){
        const brothers=[];
        const _parentDiv=parentDiv;
        const {space,id}=getDivData(parentDiv);
        const $brothers=getCacheData(id,'brothers');
        if($brothers){
            return $brothers;
        }
        while(true){
            parentDiv=parentDiv.previousElementSibling;
            if(!parentDiv){
                break;
            }
            const {space:_space}=getDivData(parentDiv);
            if(space==_space){
                brothers.push(parentDiv);
            }
            if(space>_space){
                break;
            }
        }
        brothers.reverse();
        parentDiv=_parentDiv;
        while(true){
            parentDiv=parentDiv.nextElementSibling;
            if(!parentDiv){
                break;
            }
            const {space:_space}=getDivData(parentDiv);
            if(space==_space){
                brothers.push(parentDiv);
            }
            if(space>_space){
                break;
            }
        }
        setCacheData(id,'brothers',brothers);
        return brothers;
    }

    function checkedAllChildren(parentDiv,isChecked=true){
        const chidlren=findChidren(parentDiv);
        for(let child of chidlren){
            getChildInput(child).checked=isChecked;
        }
    }
    function canceldAllChildren(parentDiv){
        checkedAllChildren(parentDiv,false);
    }

    function checkedAllParents(parentDiv,isChecked=true){
        const parents=findParents(parentDiv);
        for(let parent of parents){
            getChildInput(parent).checked=isChecked;
        }
    }
    function canceldAllParents(parentDiv){
        checkedAllParents(parentDiv,false);
    }

    function hideChildren(parentDiv,isHide=true){
        const children=findChidren(parentDiv);
        for(let child of children){
            if(isHide){
                child.style.display='none';
            }else{
                child.style.display='block';
            }
        }
    }
    function showChildren(parentDiv){
        hideChildren(parentDiv);
    }

    function createSendValue(value,type){
        return{
            key:value,
            type,
            arrayAble:false
        }
    }
    function setIsArraySign(values){
        let isArray=false;
        for(let value of values){
            if(value.key == '[' || value.type == '['){
                isArray=true;
            }
            if(isArray){
                value.arrayAble=true;
            }
        }
    }
    function removeSignItem(values){
        values=values.filter(item=>item.key != '{');
        for(let i=0;i<values.length;i++){
            const item=values[i];
            if(item.type == '[' && i != values.length-1){
                values.splice(i+1,0,{key:'[',type:'',arrayAble:true});
            }
        }
        return values.map(item=>item.key == '['?null:item);
    }
    function getSelectedLeaf(){
        const result=[];
//        const selected=[...document.querySelectorAll('input[data-isleaf="true"]:checked')];
        const selected=[...document.querySelectorAll('input[data-customer="true"]')];
        for(let leaf of selected){
            let value=getDivData(leaf).item;
            if(value){
                result.push(JSON.parse(value).map(item=>item?item.key:item));
                continue;
            }
            const div=getParentDiv(leaf);
            value=decodeURIComponent(getDivData(div).item);
            let type=getDivData(div).type;
            value=createSendValue(value,type);
            const parents=findParents(div);
            let _values=parents.reverse().reduce((res,item)=>{
                const _value=decodeURIComponent(getDivData(item).item);
                let type=getDivData(item).type;
                return (res.push(createSendValue(_value,type)),res);
            },[]);
            _values.push(value);
            setIsArraySign(_values);
            _values=removeSignItem(_values);
            leaf.dataset.item=JSON.stringify(_values);
//            result.push(_values);
            result.push(_values.map(item=>item?item.key:item));
        }
        console.log(result);
        return result;
    }

    function parseText(str){
        try{
            return JSON.parse(str);
        }catch(e){
            return '';
        }
    }
    function checkIsObj(value){
        return Array.isArray(value) || ({}).toString.call(value).toLowerCase() == '[object object]';
    }
    function emptyNotObjectValue(key,value){
        if(checkIsObj(value)){
            return value;
        }
        return '';
    }
    function repeatSpace(num){
        return Array.apply(Array,{length:num+1}).join('    ');
    }
    document.body.ondblclick=function(){
//        if(!doubleckicksign) {
//            doubleckicksign=1;
//            resultDOM.scrollIntoView(true);
//        }else{
//            doubleckicksign=0;
//            containerDOM.scrollIntoView(true);
//        }
    }
    document.querySelector('#merge').onclick=function(){
        const [lefttext,righttext]=[leftarea.value,rightarea.value];
        $.post('./merge.jsp',{
            data:{
                leftJson:parseText(lefttext),
                rightJson:parseText(righttext)
            },
            method:'POST',
            success:function(data){
                deal(JSON.stringify(data,null,4))
            }
        });
    }
    leftarea.onchange=function(){
        const value=this.value;
        const data=parseText(value);
        deal(JSON.stringify(data,emptyNotObjectValue,4))
    }
    function showdiffResult(resp,index=0){
        const lists=resp.comparedNodeList.slice(index,index+500);
        if(lists.length){
            const _list=lists.map(function(item,index){
                const space=repeatSpace(item.depth);
                const resultFlag=item.resultFlag;
                const elementName=item.elementName;
                const base=item.base,type=item.baseType;
                let changed=resultFlag=='CHANGED'?`<span class="changedtext">${item.base}->${item.changed}</span>`:`${base}`;
                if(type == 'ARRAY' || type == 'OBJECT'){
                    changed='';
                }
                return `<div class="${resultFlag.toLowerCase()}"><pre>${space}${elementName}${changed?':':''} ${changed}</pre></div>`;
            });
            diffresultDOM.insertAdjacentHTML('beforeend',_list.join(''));
            setTimeout(()=>showdiffResult(resp,index+500),0);
        }
    }
    document.querySelector('#diff').onclick=function(){
        let now=new Date();
        const [lefttext,righttext,lefturl,righturl]=[leftarea.value,rightarea.value,leftUrlDOM.value,rightUrlDOM.value];
        const invalid=document.querySelector(':invalid');
        if(invalid){
            alert('输入无效');
            return false;
        }
        const formatIncludeList=showItem.filter(item=>item.checked).map(item=>item.value);
        const filters=[...filtercontainer.querySelectorAll('[data-role="filters"]')];
        const customerFilters=[];
        filters.forEach(filter=>{
            const v=[...filter.querySelectorAll('[data-role="filteritem"]')].map(item=>{
                return item.dataset.all=='true'?-1:item.value;
            });
            const isIgnoreSon=filter.querySelector('[data-role="ignoreson"]').checked;
            if(isIgnoreSon){
                v.push(-2);
            }
            customerFilters.push(v);
        });
        console.log([...ignoreArr,...customerFilters]);
        const leftcontent=lefturl || lefttext;
        if(!leftcontent){
            alert('数据不能为空');
            return;
        }
        const headerValue=header.value;
        let headers;
        if(headerValue){
            try{
                headers=JSON.parse(headerValue);
            }catch(e){
            }
        }
        $.ajax({
            url:'./json/diff',
            headers:headers||{},
            data:JSON.stringify({
                leftJson:lefttext,
                rightJson:righttext,
                leftUrl:leftcontent,
                rightUrl:righturl,
                type:difftype,
                ignoreList:[...ignoreArr,...customerFilters],
                formatIncludeList
            }),
            type:'POST',
            dataType: 'json',
            contentType: 'application/json',
            success:function(resp){
                if(resp.status == 200){
                    diffresultDOM.innerHTML='';
                    showdiffResult(resp);
                    diffresultDOM.scrollIntoView(true);
                    const root=document.querySelector('[data-id="id1"] .js_span');
                    if(root.innerHTML == expand){
                        root.click();
                    }
                }else{
                    alert(resp.message);
                }

            }
        });
    }

</script>
</body>
</html>