<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta charset="utf-8" />
    <style>
        form{
            width: 90%;
            border: 1px solid #c3c3c3;
            margin: 0 auto;
            padding: 10px 20px;
            margin-top: 100px;
        }
        label{
            display: inline-block;
            width: 120px;
        }
        select{
            display: inline-block;
            min-width: 100px;
            margin-right: 40px;
        }
        input[type=text]{
            display: inline-block;
            width: 200px;
        }
        .selected{
            position: relative;
            *_zoom: 1;
            *_display: inline;
            display: inline-block;
            text-align: center;
            margin-right: 10px;
        }
        .selected>input{
            padding:0 10px;
            min-width: 50px;
        }
        .selected>a{
            position: absolute;
            right: 10px;
            text-decoration: none;
        }
        .suer{
            text-align: center;
        }
    </style>
</head>
<body>
<form action="/test.jsp" id="form" method="get">
    <p><label>产品组合名称:</label><input name="" data-tip="产品组合名称"/></p>
    <p><label>售卖价格:</label><input id="price" name="" data-tip="售卖价格"/></p>
    <p>
        <label>子产品:</label>
        <select id="type"></select>
        <select id="coupon"></select>
        <input type="button" value="添加" id="add" />
    </p>
    <div id="selected_content">
    </div>
    <p><label>产品组合标题:</label><input name="" data-tip="产品组合标题"></p>
    <p><label>产品展示文案:</label><input name="" data-tip="产品展示文案"></p>
    <p class="suer"><input type="submit" value="确认" /></p>
</form>
<script>
    var data={
        '专车$1':['一元$2','两元$3'],
        '车车$4':['三元$5','四元$6','五元$7'],
        '搭车$8':['六元$9','七元$10'],
        '阿迪王$11':['八元$12','九元$13','十元$14']
    };
</script>
<script>
;(function(){
    var SELECTED_DATA=[];
    String.prototype.trim=String.prototype.trim || function(){
        return this.replace(/^\s+/,'').replace(/\s+$/,'');
    }
    var inputs=document.getElementsByTagName('input');
    function createCouponOptions(data){
        var coupon=document.getElementById('coupon');
        coupon.length=0;
        coupon.appendChild(createOptions(data));
    }

    function createSelectedInput(type,coupon){
        var _type=splitValueAndCode(type),
            _coupon=splitValueAndCode(coupon);
        var text=_coupon[0]
        var html='<p class="selected">' +
                    '<input value="'+text+'" disabled/>' +
                    '<input name="packageContentStr" type="hidden" value="'+_type[1]+','+_coupon[1]+'"/>'
                    '<a data-type="'+type+'" data-coupon="'+coupon+'" href="javascript:void 0" action-type="del">x</a>' +
                '</p>'
        document.getElementById('selected_content').insertAdjacentHTML('beforeend',html)
    }
    function splitValueAndCode(str){
        return str.split('$');
    }
    function createOptions(data){
        var fragment=document.createDocumentFragment();
        for(var i=0;i<data.length;i++){
            var option=document.createElement('option');
            var _data=splitValueAndCode(data[i]);
            option.value=data[i];
            option.innerHTML=_data[0];
            fragment.appendChild(option);
        }
        return fragment;
    }
    function createSelect(){
        var arr=[];
        for(var i in data){
            if(data.hasOwnProperty(i)){
                arr.push(i);
            }
        }
        document.getElementById('type').appendChild(createOptions(arr));
        createCouponOptions(data[arr[0]]);
    }

    function findByData(type,coupon){
        for(var i=0;i<SELECTED_DATA.length;i++){
            var item=SELECTED_DATA[i];
            if(item[0] ==  type && item[1] == coupon){
                return i;
            }
        }
        return -1;
    }

    function checkHasSelected(type,coupon){
        return findByData(type,coupon)!=-1;
    }

    function addSelectedData(type,coupon){
        SELECTED_DATA.push([type,coupon]);
    }

    function removeSelectedData(type,coupon){
        var index=findByData(type,coupon);
        if(index != -1){
            SELECTED_DATA.splice(index,1);
        }
    }

    function bindEvent(){
        document.getElementById('type').onchange=function(){
            var value=this.value;
            createCouponOptions(data[value]);
        }
        document.getElementById('add').onclick=function(){
            var type=document.getElementById('type').value,
                coupon=document.getElementById('coupon').value;
            if(checkHasSelected(type,coupon)){
                return false;
            }
            addSelectedData(type,coupon);
            createSelectedInput(type,coupon);
        }

        document.getElementById('form').onsubmit=function(){
            for(var i=0;i<inputs.length;i++){
                var input=inputs[i];
                if(input.value.trim().length == 0){
                    var tip=input.getAttribute('data-tip');
                    if(tip){
                        alert(tip+'不能为空');
                        return false;
                    }
                }
            }
            var price=document.getElementById('price').value;
            if(!/^\d+(\.\d+)?$/.test(price)){
                alert('价格只能为数字');
                return false;
            }
            if(SELECTED_DATA.length == 0){
                alert('子产品不能为空');
                return false;
            }
        }

        document.body.onclick=function(e){
            e=e||window.event;
            var srcDom= e.target || e.srcElement;
            if(srcDom.getAttribute('action-type') == 'del'){
                var type=srcDom.getAttribute('data-type'),
                    coupon=srcDom.getAttribute('data-coupon');
                removeSelectedData(type,coupon);
                var parent=srcDom.parentNode;
                parent.outerHTML='';
            }
        }
    }

    function init(){
        createSelect();
        bindEvent();
    }

    init();
})();
</script>
</body>
</html>