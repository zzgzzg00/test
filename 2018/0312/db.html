<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<script>
{
    const createDBInfo={
        info:function(db,type,version){
            return{
                db:db,
                type:type,
                version:version
            }
        },
        indexedDB:function(db,version){
            return createDBInfo.info(db,indexedDB,version);
        },
        webSQL:function(db,version){
            return createDBInfo.info(db,openDatabase,version);
        }
    };

    function timeoutReject(reject,info){
        setTimeout(function(){
            reject(new Error(info || '操作超时'));
        },2000);
    }

    function getSupportDBType() {
        if (window.indexedDB) {
            return indexedDB;
        }
        return openDatabase;
    }

    const open={
        indexedDB:function(dbname,version,resolve,reject){
            const request=indexedDB.open(dbname,version);
            request.onerror=function(e){
                reject(new Error(e.currentTarget.error.message));
            };
            request.onsuccess=function(e){
                const db=e.target.result;
                resolve(createDBInfo.indexedDB(db,version));
            };
            request.onupgradeneeded=function(e){
                const db=e.target.result;
                resolve(createDBInfo.indexedDB(db,version));
            };
        },
        webSQL:function(dbname, version, desc, size,resolve,reject){
            const db = openDatabase(dbname, version, desc, size);
            resolve(createDBInfo.webSQL(db,version));
            timeoutReject(reject,'打开webSQL失败')
        }
    };

    const close={
        indexedDB:function(db,resolve,reject){
            db.onclose=resolve;
            db.close();
        },
        webSQL:function(db,resolve,reject){
            resolve();
        }
    }

    function openDB(dbname, version, type, desc, size) {
        version = version || 1;
        if(type){
            if(['indexedDB','openDatabase'].indexOf(type) == -1){
                type = 'indexedDB';
            }
        }
        type = type ? window[type] ? window[type] : getSupportDBType() : getSupportDBType();
        desc = desc || dbname;
        size = size || 2*1024*1024;
        return new Promise(function openDataBasePromise(resolve,reject){
            if(type == indexedDB){
                open.indexedDB(dbname,version,resolve,reject);
            }else{
                open.webSQL(dbname,version,desc,size,resolve,reject);
            }
        });
    }
    function closeDB(dbInfo){
        return new Promise(function closeDataBasePromise(resolve,reject){
            close[dbInfo.db](resolve,reject);
        });
    }
    window.openDB=openDB;
}
openDB('test',1)
    .then(function getDB(db){
        console.log(db);
    })

    .catch(function getFailReason(error){
        console.log(error);
    });
</script>
</body>
</html>