<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta charset="utf-8" />
</head>
<body>
<script src="//q.qunarzz.com/open_m_train/prd/scripts/zepto@5f84d4ac791c84f64346aec65b2a0083.js"></script>
<script src="//api.map.baidu.com/api?v=1.4&ak=h7KwRB1TZEHVaspIMtQr6fj1&s=1" type="text/javascript"></script>
<script>
    function getCity(defaultCity,totalTimeout,locationTimeout,getCityTimeout){
        totalTimeout=totalTimeout*1000 || 7000;
        var d= $.Deferred();
        var handle=window.setTimeout(function(){
            d.reject({
                status:2,
                msg:'定位超时'
            })
        },totalTimeout);
        function resolveDeferred(d,handle,data){
            if(!resolveDeferred.hasDeferred){
                handle && clearTimeout(handle);
                d.resolve(data);
                resolveDeferred.hasDeferred=1;
            }
            return d;
        }
        getLocation(locationTimeout)
            .then(function(data){
                return firstResolve([getCityByBaiduMap(data),getCityByServer(data)],getCityTimeout)
            })
            .then(function(data){
                resolveDeferred(d,handle,data)
            })
            .fail(function(data){
                getCityByIp()
                    .then(function(data){
                        resolveDeferred(d,handle,data);
                    },function(){
                        d.reject({
                            status:1,
                            msg:'定位失败'
                        });
                    })
            })
        return d;
    }
    function getLocation(timeout){
        timeout=timeout*1000 || 2000;
        var d= $.Deferred();
        var handle=window.setTimeout(function(){
            d.reject({
                status:-6,
                msg:'获取经纬度失败'
            });
        },timeout);
        if(navigator.geolocation && navigator.geolocation.getCurrentPosition){
            navigator.geolocation.getCurrentPosition(function(position){
                var lat = position.coords.latitude,
                    lon = position.coords.longitude;
                handle && clearTimeout(handle);
                d.resolve({
                    status:0,
                    lat:lat,
                    lon:lon
                });
            });
        }else{
            d.reject({
               status:-1,
               msg:'location error'
            });
        }
        return d;
    }
    function checkLocation(data){
        if(data.lat == undefined || data.lon == undefined){
            return false;
        }
        return true;
    }
    function firstResolve(deferredarr,timeout){
        var d= $.Deferred();
        timeout=timeout*1000 || 3000;
        var len=deferredarr.length,failReason=[],index= 0,handle;
        handle=setTimeout(function(){
            d.reject({
                status:-7,
                msg:'等待超时'
            });
        },timeout);
        deferredarr.forEach(function(item,_index){
            item
                .then(function(data){
                    handle && clearTimeout(handle);
                    d.resolve(data);
                }).fail(function(data){
                    failReason[index]=data;
                    index++;
                    if(index >= len){
                        handle && clearTimeout(handle);
                        d.reject(failReason);
                    }
                })
        })
        return d;
    }
    function getCityByBaiduMap(data){
        var d= $.Deferred();
        if(!window.BMap){
            d.reject({
                'status':-2,
                'msg':'缺少依赖库'
            });
            return d;
        }
        if(!checkLocation(data)){
            d.reject({
                status:-5,
                msg:'参数缺失'
            });
            return d;
        }
        var point = new BMap.Point(data.lon, data.lat),
            gc = new BMap.Geocoder();
        gc.getLocation(point, function (rs) {
            var addComp = rs.addressComponents;
            d.resolve({
                'status':0,
                'from':'baidu',
                'province':addComp.province,
                'city':addComp.city&&addComp.city.replace(/市$/,''),
                'district':addComp.district,
                'street':addComp.street,
                'streetNumber':addComp.streetNumber
            });
        });
        return d;
    }
    function getCityByServer(data){
        var d= $.Deferred();
        if(!checkLocation(data)){
            d.reject({
                status:-5,
                msg:'参数缺失'
            });
            return d;
        }
        $.ajax({
            url: "//touch.qunar.com/h5/coach/common/location.json",
            data: {
                longitude:data.lon,
                latitude:data.lat,
                type:1,
                from:'train',
                level:1,
                _t: +new Date()
            },
            dataType: "jsonp",
            success: function(res) {
                if(res.status == 0){
                    var addComp=res.data ||{}
                    d.resolve({
                        status:0,
                        from:'server',
                        province:addComp.province,
                        city:addComp.city,
                        district:addComp.district,
                        street:addComp.street,
                        streetNumber:addComp.streetNumber
                    });
                }
            }
        });
        return d;
    }
    function getCityByIp(){
        var d= $.Deferred();
        $.ajax({
            url: "https://api.qunar.com/ips.jcp",
            data: {
                '_t': +new Date()
            },
            dataType: "jsonp",
            success: function(res) {
                d.resolve({
                    status:0,
                    from:'ip',
                    city:res.city
                });
            }
        });
        return d;
    }

    getCity('',7,2,3)
        .then(function(data){
            alert(JSON.stringify(data,null,4))
        })
        .fail(function(data){
            alert(JSON.stringify(data,null,4))
        })
</script>
</body>
</html>