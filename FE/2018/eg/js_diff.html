<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        *{
            padding: 0;
            margin: 0;
            box-sizing: border-box;
            line-height: 1.1;
        }
        summary:focus{
            outline: none;
        }
        input[type=checkbox]{
            margin-right: 5px;
        }
        #container,#show{
            padding: 20px;
        }
        .write{
            height: 50vh;
            width: 45.5vw;
            display: inline-block;
            margin-left: 3vw;
            border:1px solid grey;
        }
    </style>
</head>
<body>
<textarea class="write"></textarea><textarea class="write"></textarea>
<div id="container">

</div>
<div id="show"></div>
<script>
    function checkIsObjectOrArray(obj){
        if(obj === null){
            return false;
        }
        return ({}).toString.call(obj).toLowerCase() == '[object object]' || Array.isArray(obj);
    }
    function union(obj1,obj2,obj={}){
        const [keys1,keys2]=[Object.keys(obj1),Object.keys(obj2)];
        const [obj1haskey,obj2haskey,commonkeys]=[keys1.filter(item=>keys2.indexOf(item) == -1),
                                         keys2.filter(item=>keys1.indexOf(item) == -1),
                                         keys1.filter(item=>keys2.indexOf(item) != -1)];
        for(let key of obj1haskey){
            obj[key]=obj1[key];
        }
        for(let key of obj2haskey){
            obj[key]=obj2[key];
        }
        for(let key of commonkeys){
            const [item1,item2]=[obj1[key],obj2[key]];
            if(!checkIsObjectOrArray(item1) && !checkIsObjectOrArray(item2)){
                obj[key]=1;
            }else if(!checkIsObjectOrArray(item1) && checkIsObjectOrArray(item2)){
                obj[key]=item2;
            }else if(checkIsObjectOrArray(item1) && !checkIsObjectOrArray(item2)){
                obj[key]=item1;
            }else{
                obj[key]={};
                union(item1,item2,obj[key]);
            }
        }
        return obj;
    }
    class CustomTree{
        constructor(obj,containerDom,showDom,defaultSep='.',root='root'){
            Object.assign(this,{containerDom,showDom,defaultSep,root,detailsArr:[]});
            this.addEvent();
            this.createRoot();
            const lists=this.serailize(obj);
            for(let list of lists){
                setTimeout(()=>this.createTree(list),0);
                this.createTree(list);
            }
        }
        createRoot(){
            const root=this.createDetails(this.root,this.root,true);
            root.style.textIndent='0em';
            this.containerDom.appendChild(root);
            this.containerDom=root;
        }
        serailize(obj,_key='') {
            const keys=Object.keys(obj);
            const arr=[];
            for(let key of keys){
                const item=obj[key];
                if(checkIsObjectOrArray(item)){
                    arr.push(...this.serailize(item,`${_key?_key+this.defaultSep:_key}${key}`));
                }else{
                    arr.push(`${_key?_key+this.defaultSep:_key}${key}`);
                }
            }
            return arr;
        }
        createTree(str){
            const arr=str.split(this.defaultSep);
            arr.reduce((key,name,index)=>{
                let id=!key?name:`${key}${this.defaultSep}${name}`,
                    details=this.createDetails(id,name,index != arr.length-1),
                    parentNode=!key?this.containerDom:this.findDetails(key);
                parentNode.appendChild(details);
                return id;
            },'')
        }
        createDetails(id,name,isdetails){
            if(this.findDetails(id)){
                return this.findDetails(id);
            }
            const details=document.createElement(isdetails?'details':'p');
            details.id=id;
            details.style.textIndent=id.split(this.defaultSep).length+'em';
            if(isdetails){
                const summary=document.createElement('summary');
                summary.innerHTML=`<input type="checkbox" value="${id}">${name}`;
                details.appendChild(summary);
            }else{
                details.innerHTML=`<span style="visibility: hidden;">æˆ‘</span><input type="checkbox" value="${id}">${name}`;
            }
            this.detailsArr.push(details);
            return details;
        }
        findDetails(id){
            return this.detailsArr.filter(item=>item.id == id)[0];
        }
        addEvent() {
            this.containerDom.addEventListener('click',e=>{
                const target=e.target;
                if(target.tagName.toLowerCase() == 'input' && target.type == 'checkbox'){
                    if(target.parentNode.tagName.toLowerCase() == 'summary'){
                        const closestDetail=target.closest('details');
                        closestDetail.querySelectorAll('input[type="checkbox"]').forEach(function(item){
                            item.checked=target.checked;
                        });
                    }
                    this.showDom.innerHTML=this.findAllChecked();
                }
            },false)
        }
        findAllChecked(){
            return [...this.containerDom.querySelectorAll('p input[type="checkbox"]:checked')].map(function(item){
                return `<p>${item.value}</p>`;
            }).join('')
        }
    }

    const container=document.getElementById('container');
    const show=document.getElementById('show');

    fetch('../testdata/verification.json')
        .then(response=>response.json())
        .then(data=>new CustomTree(data,container,show))

//    let o1={},o2={};
//    const [write1,write2]=document.querySelectorAll('.write');
//    write1.onchange=write2.onchange=function(){
//        container.innerHTML='';
//        show.innerHTML='';
//        try{
//            o1=JSON.parse(write1.value);
//        }catch{
//            alert('left json error');
//            o1={}
//        }
//        try{
//            o2=JSON.parse(write2.value);
//        }catch{
//            alert('right json error');
//            o2={}
//        }
//        new CustomTree(union(o1||{},o2||{}),container,show);
//    };
//
//    //test
//    const str1=`{"format":"example","content":[{"align":"center","depth":0,"list":false,"content":[{"style":{"underline":1,"bold":2,"size":20,"italic":2,"color":"FFFFFF","fontFamily":"Arial"},"content":"And please, feel free to send us your feedback and comments to "},{"style":{"underline":1,"bold":2,"size":20,"italic":2,"color":"4DC3FF","fontFamily":"Arial"},"content":"hello world"},{"style":{"underline":1,"bold":2,"size":20,"italic":2,"color":"FFFFFF","fontFamily":"Arial"},"content":", or just by clicking on the "},{"style":{"underline":1,"bold":2,"size":20,"italic":2,"color":"4DC3FF","fontFamily":"Arial"},"content":"feedback"}],"ordered":false}],"version":3}`;
//    const str2=`{"format":"example","version":3.1,"content":[{"list":false,"depth":0,"ordered":false,"content":[{"content":"And please, feel free to send us your feedback and comments to ","style":{"size":20,"color":"FFFFFF","name":"Arial","bold":2,"italic":2,"underline":2}},{"content":"foo","style":{"size":20,"color":"4DC2FF","name":"Arial","bold":2,"italic":2,"underline":2}},{"content":", or just by clicking on the ","style":{"size":20,"color":"FFFFFF","name":"Arial","bold":2,"italic":2,"underline":2}},{"content":"feedback","style":{"size":20,"color":"4DC2FF","name":"Arial","bold":2,"italic":2,"underline":2}},{"content":" button up above.","style":{"size":20,"color":"FFFFFF","name":"Arial","bold":2,"italic":2,"underline":2}}],"align":"center"}]}`
//    write1.value=str1;
//    write2.value=str2;
//    write1.onchange();
</script>
</body>
</html>