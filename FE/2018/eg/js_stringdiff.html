<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
    <div id='container'></div>
    <div id='result'></div>
<script>
    const containerDOM=document.querySelector('#container');
    const resultDOM=document.querySelector('#result');
    const fold='▶',expand='▼',defaultSperator='.';
    function deal(data){
        const arr=data.split(/\n/);
        const reg=/^(\s+)(.*$)/g
        const html=arr.map((item,index,arr)=>{
            item=item.replace(reg,'$2')//.replace(/:.*$/,'');
            const space=RegExp.$1;
            item=item.replace(/"(.*?)":.*$/,'$1');
            const isLeaf=arr[index+1]?arr[index+1].indexOf(space+' ')!=0:true;
            const button=isLeaf?'':`<span>${expand}</span>`;
            return `<div data-space="${space.length/4}" data-item="${encodeURIComponent(item)}">
                        <pre>${space}${button}<input data-isleaf="${isLeaf}" type="checkbox" />${item}</pre>
                    </div>`
        });
        containerDOM.innerHTML=html.join('');
    }
    document.body.onclick=function(e){
        const target=e.target;
        if(target.tagName.toLowerCase()=='input'){
            const div=getParentDiv(target);
            if(target.checked){
                checkedAllChildren(div);
                checkedAllParents(div);
            }else{
                canceldAllChildren(div);
                if(!getBrothersStatus(div)){
                    canceldAllParents(div);
                }
            }
            const result=getSelectedLeaf();
            resultDOM.innerHTML=result.map(item=>`<p>${item}</p>`).join('');
        }else if(target.tagName.toLowerCase()=='span'){
            const div=getParentDiv(target);
            if(target.innerHTML==expand){
                hideChildren(div);
                target.innerHTML=fold;
            }else{
                hideChildren(div,false);
                target.innerHTML=expand;
            }

        }
    }

    function getDivData(parentDiv){
        return parentDiv.dataset;
    }

    function getParentDiv(input){
        return input.closest('div');
    }
    function getChildInput(parentDiv){
        return parentDiv.querySelector('input');
    }
    function getBrothersStatus(parentDiv){
        const brothers=findBrothers(parentDiv);
        for(let brother of brothers){
            if(getChildInput(brother).checked){
                return true;
            }
        }
        return false;
    }


    function findParents(parentDiv){
        const parents=[];
        let {space}=getDivData(parentDiv);
        --space;
        while(true){
            if(space==0){
                break;
            }
            parentDiv=parentDiv.previousElementSibling;
            const {space:_space}=getDivData(parentDiv);
            if(space==_space){
                parents.push(parentDiv);
                --space;
            }
        }
        return parents;
    }
    function findChidren(parentDiv){
        const children=[];
        const {space}=getDivData(parentDiv);
        while(true){
            parentDiv=parentDiv.nextElementSibling;
            const {space:_space}=getDivData(parentDiv);
            if(_space>space){
                children.push(parentDiv);
            }else{
                break;
            }
        }
        return children;
    }
    function findBrothers(parentDiv){
        const brothers=[];
        const _parentDiv=parentDiv;
        const {space}=getDivData(parentDiv);
        while(true){
            parentDiv=parentDiv.previousElementSibling;
            const {space:_space}=getDivData(parentDiv);
            if(space==_space){
                brothers.push(parentDiv);
            }
            if(space>_space){
                break;
            }
        }
        brothers.reverse();
        parentDiv=_parentDiv;
        while(true){
            parentDiv=parentDiv.nextElementSibling;
            const {space:_space}=getDivData(parentDiv);
            if(space==_space){
                brothers.push(parentDiv);
            }
            if(space>_space){
                break;
            }
        }
        return brothers;
    }

    function checkedAllChildren(parentDiv,isChecked=true){
        const chidlren=findChidren(parentDiv);
        for(let child of chidlren){
            getChildInput(child).checked=isChecked;
        }
    }
    function canceldAllChildren(parentDiv){
        checkedAllChildren(parentDiv,false);
    }

    function checkedAllParents(parentDiv,isChecked=true){
        const parents=findParents(parentDiv);
        for(let parent of parents){
            getChildInput(parent).checked=isChecked;
        }
    }
    function canceldAllParents(parentDiv){
        checkedAllParents(parentDiv,false);
    }

    function hideChildren(parentDiv,isHide=true){
        const children=findChidren(parentDiv);
        for(let child of children){
            if(isHide){
                child.style.display='none';
            }else{
                child.style.display='block';
            }
        }
    }
    function showChildren(parentDiv){
        hideChildren(parentDiv);
    }

    function getSelectedLeaf(){
        const result=[];
        const selected=[...document.querySelectorAll('input[data-isleaf="true"]:checked')];
        for(let leaf of selected){
            let value=getDivData(leaf).item;
            if(value){
                result.push(decodeURIComponent(value));
                continue;
            }
            const div=getParentDiv(leaf);
            value=decodeURIComponent(getDivData(div).item);
            const parents=findParents(div);
            value=parents.reduce((a,b)=>{
                return a+decodeURIComponent(getDivData(b).item)+defaultSperator;
            },'')+value;
            leaf.dataset.item=encodeURIComponent(value);
            result.push(value);
        }
        return result;
    }

    fetch('../testdata/verification.json')
        .then(response=>response.json())
        .then(data=>deal(JSON.stringify(data,null,4)))
</script>
</body>
</html>