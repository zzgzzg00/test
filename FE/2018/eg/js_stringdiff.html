<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
    <div id='container'>
        <div data-id="id0" data-space="0" data-item="root">
            <pre><span>▼</span><input data-isleaf="false" type="checkbox" />root</pre>
        </div>
    </div>
    <div id='result'></div>
<script>
    const containerDOM=document.querySelector('#container');
    const resultDOM=document.querySelector('#result');
    const fold='▶',expand='▼',defaultSperator='.';
    const caches={};
    function deal(data){
        const arr=data.split(/\n/);
        const reg=/^(\s+)(.*$)/g
        const html=arr.map((item,index,arr)=>{
            const emptyReg=/^\{|(?:\},?)$/;
            if(emptyReg.test(item)){
                return '';
            }
            item=item.replace(reg,'$2')//.replace(/:.*$/,'');
            const space=RegExp.$1;
            item=item.replace(/"(.*?)":.*$/,'$1');
            const isLeaf=arr[index+1]?arr[index+1].indexOf(space+' ')!=0:true;
            const button=isLeaf?'':`<span>${expand}</span>`;
            return `<div data-id="id${index+1}" data-space="${space.length/4}" data-item="${encodeURIComponent(item)}">
                        <pre>${space}${button}<input data-isleaf="${isLeaf}" type="checkbox" />${item}</pre>
                    </div>`
        });
        containerDOM.insertAdjacentHTML('beforeend',html.join(''));
    }
    document.body.onclick=function(e){
        const target=e.target;
        if(target.tagName.toLowerCase()=='input'){
            const div=getParentDiv(target);
            if(target.checked){
                checkedAllChildren(div);
                checkedAllParents(div);
            }else{
                canceldAllChildren(div);
                if(!getBrothersStatus(div)){
                    canceldAllParents(div);
                }
            }
            const result=getSelectedLeaf();
            resultDOM.innerHTML=result.map(item=>`<p>${item}</p>`).join('');
        }else if(target.tagName.toLowerCase()=='span'){
            const div=getParentDiv(target);
            if(target.innerHTML==expand){
                hideChildren(div);
                target.innerHTML=fold;
            }else{
                hideChildren(div,false);
                target.innerHTML=expand;
            }

        }
    }

    function getDivData(parentDiv){
        return parentDiv.dataset;
    }
    function getCacheData(id,type){
        if(!caches[id]){
            return false;
        }
        if(!caches[id][type]){
            return false;
        }
        return caches[id][type];
    }
    function setCacheData(id,type,data){
        if(!caches[id]){
            caches[id]={};
        }
        caches[id][type]=data;
    }

    function getParentDiv(input){
        return input.closest('div');
    }
    function getChildInput(parentDiv){
        return parentDiv.querySelector('input');
    }
    function getBrothersStatus(parentDiv){
        const brothers=findBrothers(parentDiv);
        for(let brother of brothers){
            if(getChildInput(brother).checked){
                return true;
            }
        }
        return false;
    }


    function findParents(parentDiv){
        const parents=[];
        let {space,id}=getDivData(parentDiv);
        const $parents=getCacheData(id,'parents');
        if($parents){
            return $parents;
        }
        --space;
        while(true){
            if(space==-1){
                break;
            }
            parentDiv=parentDiv.previousElementSibling;
            if(!parentDiv){
                break;
            }
            const {space:_space}=getDivData(parentDiv);
            if(space==_space){
                parents.push(parentDiv);
                --space;
            }
        }
        setCacheData(id,'parents',parents);
        return parents;
    }
    function findChidren(parentDiv){
        const children=[];
        const {space,id}=getDivData(parentDiv);
        const $children=getCacheData(id,'children');
        if($children){
            return $children;
        }
        while(true){
            parentDiv=parentDiv.nextElementSibling;
            if(!parentDiv){
                break;
            }
            const {space:_space}=getDivData(parentDiv);
            if(_space>space){
                children.push(parentDiv);
            }else{
                break;
            }
        }
        setCacheData(id,'children',children);
        return children;
    }
    function findBrothers(parentDiv){
        const brothers=[];
        const _parentDiv=parentDiv;
        const {space,id}=getDivData(parentDiv);
        const $brothers=getCacheData(id,'brothers');
        if($brothers){
            return $brothers;
        }
        while(true){
            parentDiv=parentDiv.previousElementSibling;
            if(!parentDiv){
                break;
            }
            const {space:_space}=getDivData(parentDiv);
            if(space==_space){
                brothers.push(parentDiv);
            }
            if(space>_space){
                break;
            }
        }
        brothers.reverse();
        parentDiv=_parentDiv;
        while(true){
            parentDiv=parentDiv.nextElementSibling;
            if(!parentDiv){
                break;
            }
            const {space:_space}=getDivData(parentDiv);
            if(space==_space){
                brothers.push(parentDiv);
            }
            if(space>_space){
                break;
            }
        }
        setCacheData(id,'brothers',brothers);
        return brothers;
    }

    function checkedAllChildren(parentDiv,isChecked=true){
        const chidlren=findChidren(parentDiv);
        for(let child of chidlren){
            getChildInput(child).checked=isChecked;
        }
    }
    function canceldAllChildren(parentDiv){
        checkedAllChildren(parentDiv,false);
    }

    function checkedAllParents(parentDiv,isChecked=true){
        const parents=findParents(parentDiv);
        for(let parent of parents){
            getChildInput(parent).checked=isChecked;
        }
    }
    function canceldAllParents(parentDiv){
        checkedAllParents(parentDiv,false);
    }

    function hideChildren(parentDiv,isHide=true){
        const children=findChidren(parentDiv);
        for(let child of children){
            if(isHide){
                child.style.display='none';
            }else{
                child.style.display='block';
            }
        }
    }
    function showChildren(parentDiv){
        hideChildren(parentDiv);
    }

    function getSelectedLeaf(){
        const result=[];
        const selected=[...document.querySelectorAll('input[data-isleaf="true"]:checked')];
        for(let leaf of selected){
            let value=getDivData(leaf).item;
            if(value){
                result.push(decodeURIComponent(value));
                continue;
            }
            const div=getParentDiv(leaf);
            value=decodeURIComponent(getDivData(div).item);
            const parents=findParents(div);
            value=parents.reverse().reduce((a,b)=>{
                return a+decodeURIComponent(getDivData(b).item)+defaultSperator;
            },'')+value;
            leaf.dataset.item=encodeURIComponent(value);
            result.push(value);
        }
        return result;
    }

    fetch('../testdata/verification.json')
        .then(response=>response.json())
        .then(data=>deal(JSON.stringify(data,null,4)))
</script>
</body>
</html>