<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        *{
            padding: 0;
            margin: 0;
            box-sizing: border-box;
            line-height: 1.1;
        }
        .container{
            display: flex;
            justify-content:center;
            align-items:center;
        }
        .container>div{
            margin: 0 10px;
        }
        .container>div>p:nth-of-type(1){
            margin-bottom: 10px;
        }
        .container>div>p{
            border:1px solid grey;
            padding: 5px 10px;
        }
        summary:focus{
            outline: none;
        }
        input[type=checkbox]{
            margin-right: 5px;
        }
        #container,#show{
            padding: 20px;
        }
        .write{
            display: block;
            border:1px solid grey;
            height: 50vh;
            flex: 1;
        }
        #mask{
            position: fixed;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,.3);
            display: flex;
            justify-content:center;
            align-items: center;
            color: #ffffff;
        }
        #mask.hide{
            display: none;
        }
        .type_select{
            margin: 10px;
            text-align: center;
        }
        .type_select>label:nth-of-type(2){
            margin-left: 20px;
        }
        ::-webkit-input-placeholder{
            color:lightslategray;
        }
        [type=url]{
            display: block;
            width: 90%;
            height: 30px;
            margin: 10px auto;
            font-size: 16px;
            line-height: 30px;
            padding: 10px;
            color: #000000;
        }
        :invalid{
            border:1px solid red;
            outline: none;
        }
    </style>
</head>
<body>
<script src="./zepto.js"></script>
<p class="type_select">
    <label for="json"><input checked name="type" id="json" type="radio">json比较</label>
    <label for="url"><input name="type" id="url" type="radio">url比较</label>
</p>
<div class="container">
    <textarea id="left" class="write"></textarea>
    <div>
        <p hidden id="merge">合并</p>
        <p id="diff">比较</p>
    </div>
    <textarea id="right" class="write" required></textarea>
</div>
<input type="url" required placeholder="left url" disabled/>
<input type="url" required placeholder="right url" disabled/>
<div id='container'>
    <!--
    <div data-id="id0" data-space="0" data-item="root">
        <pre><span>▼</span><input data-isleaf="false" type="checkbox" />root</pre>
    </div>-->
</div>
<h2>剔除项</h2>
<div id='result'></div>
<div id="mask" class="hide">生成树型结构...</div>
<script>
    const [jsonDOM,urlDOM]=document.querySelectorAll('input[type="radio"]');
    const [leftUrlDOM,rightUrlDOM]=document.querySelectorAll('input[type="url"]');
    const containerDOM=document.querySelector('#container');
    const resultDOM=document.querySelector('#result');
    const resultTextarea=document.querySelector('#resulttext');
    const [leftarea,rightarea]=document.querySelectorAll('textarea');
    const maskDOM=document.querySelector('#mask');
    const fold='▶',expand='▼',defaultSperator='.';
    let caches={};
    let ignoreArr=[];
    let doubleckicksign=0;
    const spaceReg=/^(\s+)(.*$)/g;
    const emptyReg=/^(?:(\s*\{)|(\s*\[,?))$/;
    const ignoreReg=/^\s*[\}\]],?$/;
    const keyReg=/"(.*?)(?<!\\)":(.*)$/;
    const startReg=/^\s*(\{|\[)\s*$/;
    function deal(data){
        const t1=performance.now();
        maskDOM.classList.remove('hide');
        setTimeout(()=>{
            const arr=data.split(/\n/);
            const html=arr.map((item,index,arr)=>{
                let _v='';
                item=item.replace(spaceReg,'$2');
                const space=RegExp.$1;
                item=item.replace(keyReg,'$1');
                if(startReg.test(RegExp.$2)){
                    let end=RegExp.$1;
                    if(!checkIsEmpty(item)){
                        _v=end;
                    }
                }
                const isLeaf=arr[index+1]?arr[index+1].indexOf(space+' ')!=0:true;
                const button=isLeaf?'':`<span>${expand}</span>`;
                if(ignoreReg.test(item)){
                    return `<div data-id="id${index+1}" data-space="${space.length/4}" data-item="${encodeURIComponent(item)}">
                            <pre>${space}<input hidden data-isleaf="false" type="checkbox" />${item.replace(/,/,'')}</pre>
                        </div>`
                }
                return `<div data-id="id${index+1}" data-space="${space.length/4}" data-item="${encodeURIComponent(item)}" data-type="${_v}">
                        <pre>${space}${button}<input ${emptyReg.test(item)?'hidden':''} data-isleaf="${isLeaf}" type="checkbox" />${item}${_v}</pre>
                    </div>`
            });
            containerDOM.innerHTML=html.join('');
            resultDOM.innerHTML='';
            maskDOM.classList.add('hide');
            console.log(performance.now()-t1);
            caches={};
        },0);
    }
    document.body.onclick=function(e){
        const target=e.target;
        if(target.tagName.toLowerCase()=='input' && target.type == 'checkbox'){
            const div=getParentDiv(target);
            if(target.checked){
                checkedAllChildren(div);
                checkedAllParents(div);
            }else{
                canceldAllChildren(div);
                if(!getBrothersStatus(div)){
                    canceldAllParents(div);
                }
            }
            const result=getSelectedLeaf();
            resultDOM.innerHTML=`<pre>${JSON.stringify(result,(key,value)=>key=='type'?undefined:value,4)}</pre>`;
            ignoreArr=result;
        }else if(target.tagName.toLowerCase()=='span'){
            const div=getParentDiv(target);
            if(target.innerHTML==expand){
                hideChildren(div);
                target.innerHTML=fold;
            }else{
                hideChildren(div,false);
                target.innerHTML=expand;
            }

        }else if(target.tagName.toLowerCase()=='input' && target.type == 'radio'){
            if(jsonDOM.checked){
                setReadOnly([rightarea],[leftUrlDOM,rightUrlDOM]);
            }else{
                setReadOnly([leftUrlDOM,rightUrlDOM],[rightarea]);
            }
        }
    }
    function setReadOnly(canreadarr,cannotreadarr){
        for(let read of canreadarr){
            read.disabled=false;
        }
        for(let notread of cannotreadarr){
            notread.disabled=true;
        }
    }
    function checkIsEmpty(str){
        return !/[a-z\d]/i.test(str);
    }

    function getDivData(parentDiv){
        let {id,space,item,type}=parentDiv.dataset;
        return{
            id,
            item,
            space:space<<0,
            type
        }
    }
    function getCacheData(id,type){
        if(!caches[id]){
            return false;
        }
        if(!caches[id][type]){
            return false;
        }
        return caches[id][type];
    }
    function setCacheData(id,type,data){
        if(!caches[id]){
            caches[id]={};
        }
        caches[id][type]=data;
    }

    function getParentDiv(input){
        return input.closest('div');
    }
    function getChildInput(parentDiv){
        return parentDiv.querySelector('input');
    }
    function getBrothersStatus(parentDiv){
        const brothers=findBrothers(parentDiv);
        for(let brother of brothers){
            if(getChildInput(brother).checked){
                return true;
            }
        }
        return false;
    }

    function findParents(parentDiv){
        const parents=[];
        let {space,id}=getDivData(parentDiv);
        const $parents=getCacheData(id,'parents');
        if($parents){
            return $parents;
        }
        --space;
        while(true){
            if(space==-1){
                break;
            }
            parentDiv=parentDiv.previousElementSibling;
            if(!parentDiv){
                break;
            }
            const {space:_space}=getDivData(parentDiv);
            if(space==_space){
                parents.push(parentDiv);
                --space;
            }
        }
        setCacheData(id,'parents',parents);
        return parents;
    }
    function findChidren(parentDiv){
        const children=[];
        const {space,id}=getDivData(parentDiv);
        const $children=getCacheData(id,'children');
        if($children){
            return $children;
        }
        while(true){
            parentDiv=parentDiv.nextElementSibling;
            if(!parentDiv){
                break;
            }
            const {space:_space}=getDivData(parentDiv);
            if(_space>space){
                children.push(parentDiv);
            }else{
                break;
            }
        }
        setCacheData(id,'children',children);
        return children;
    }
    function findBrothers(parentDiv){
        const brothers=[];
        const _parentDiv=parentDiv;
        const {space,id}=getDivData(parentDiv);
        const $brothers=getCacheData(id,'brothers');
        if($brothers){
            return $brothers;
        }
        while(true){
            parentDiv=parentDiv.previousElementSibling;
            if(!parentDiv){
                break;
            }
            const {space:_space}=getDivData(parentDiv);
            if(space==_space){
                brothers.push(parentDiv);
            }
            if(space>_space){
                break;
            }
        }
        brothers.reverse();
        parentDiv=_parentDiv;
        while(true){
            parentDiv=parentDiv.nextElementSibling;
            if(!parentDiv){
                break;
            }
            const {space:_space}=getDivData(parentDiv);
            if(space==_space){
                brothers.push(parentDiv);
            }
            if(space>_space){
                break;
            }
        }
        setCacheData(id,'brothers',brothers);
        return brothers;
    }

    function checkedAllChildren(parentDiv,isChecked=true){
        const chidlren=findChidren(parentDiv);
        for(let child of chidlren){
            getChildInput(child).checked=isChecked;
        }
    }
    function canceldAllChildren(parentDiv){
        checkedAllChildren(parentDiv,false);
    }

    function checkedAllParents(parentDiv,isChecked=true){
        const parents=findParents(parentDiv);
        for(let parent of parents){
            getChildInput(parent).checked=isChecked;
        }
    }
    function canceldAllParents(parentDiv){
        checkedAllParents(parentDiv,false);
    }

    function hideChildren(parentDiv,isHide=true){
        const children=findChidren(parentDiv);
        for(let child of children){
            if(isHide){
                child.style.display='none';
            }else{
                child.style.display='block';
            }
        }
    }
    function showChildren(parentDiv){
        hideChildren(parentDiv);
    }

    function createSendValue(value,type){
        return{
            key:value,
            type,
            arrayAble:false
        }
    }
    function setIsArraySign(values){
        let isArray=false;
        for(let value of values){
            if(value.key == '[' || value.type == '['){
                isArray=true;
            }
            if(isArray){
                value.arrayAble=true;
            }
        }
    }
    function removeSignItem(values){
//        return values;
        return values.filter(item=>item.key != '[' && item.key != '{');
    }
    function getSelectedLeaf(){
        const result=[];
        const selected=[...document.querySelectorAll('input[data-isleaf="true"]:checked')];
        for(let leaf of selected){
            let value=getDivData(leaf).item;
            if(value){
                result.push(JSON.parse(value));
                continue;
            }
            const div=getParentDiv(leaf);
            value=decodeURIComponent(getDivData(div).item);
            let type=getDivData(div).type;
            value=createSendValue(value,type);
            const parents=findParents(div);
            let _values=parents.reverse().reduce((res,item)=>{
                const _value=decodeURIComponent(getDivData(item).item);
                let type=getDivData(item).type;
                return (res.push(createSendValue(_value,type)),res);
            },[]);
            _values.push(value);
            setIsArraySign(_values);
            _values=removeSignItem(_values);
            leaf.dataset.item=JSON.stringify(_values);
            result.push(_values);
        }
        console.log(result);
        return result;
    }

    function parseText(str){
        try{
            return JSON.parse(str);
        }catch(e){
            return '';
        }
    }
    document.body.ondblclick=function(){
        if(!doubleckicksign) {
            doubleckicksign=1;
            resultDOM.scrollIntoView(true);
        }else{
            doubleckicksign=0;
            containerDOM.scrollIntoView(true);
        }
    }
    document.querySelector('#merge').onclick=function(){
        const [lefttext,righttext]=[leftarea.value,rightarea.value];
        $.post('./merge.jsp',{
            data:{
                leftJson:parseText(lefttext),
                rightJson:parseText(righttext)
            },
            method:'POST',
            success:function(data){
                deal(JSON.stringify(data,null,4))
            }
        });
    }
    leftarea.onchange=function(){
        const value=this.value;
        const data=parseText(value);
        deal(JSON.stringify(data,null,4))
    }
    document.querySelector('#diff').onclick=function(){
        const [lefttext,righttext,lefturl,righturl]=[leftarea.value,rightarea.value,leftUrlDOM.value,rightUrlDOM.value];
        const invalid=document.querySelector(':invalid');
        if(invalid){
            alert('输入无效');
            return false;
        }
        $.post('./diff.jsp',{
            data:{
                leftJson:parseText(lefttext),
                rightJson:parseText(righttext),
                lefturl,
                righturl,
                ignoreList:ignoreArr
            },
            method:'POST'
        });
    }
//    fetch('../testdata/verification.json')
//        .then(response=>response.json())
//        .then(data=>deal(JSON.stringify(data,null,4)))
</script>
</body>
</html>